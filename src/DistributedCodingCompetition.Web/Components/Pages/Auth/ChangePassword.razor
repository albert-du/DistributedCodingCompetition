@page "/auth/password/change"
@inject IUserStateService UserStateService
@inject IAuthService AuthService
<AuthCheck />

<PageTitle>Change Password</PageTitle>

<h2 class="text-3xl">Change Password</h2>

@if (done)
{
    <div>Password changed successfully</div>
    <a class="text-violet-800 italic hover:underline" href="dashboard">dashboard</a>
}
else if (loading)
{
    <LoadingSpinner />
}
else
{
    <EditForm Enhance Model=Model OnValidSubmit=SubmitAsync FormName="change-password-form">
        <label class="flex flex-col">
            Current Password
            <InputText class="w-64 px-2 py-1 ml-2 bg-gray-100 rounded-lg text-slate-800" type="password" @bind-Value=Model.CurrentPassword />
            <div class="h-2 text-rose-500">
                <ValidationMessage For=@(() => Model.CurrentPassword) />
            </div>
        </label>

        <label class="flex flex-col">
            <span>New Password</span>
            <InputText class="w-64 px-2 py-1 ml-2 bg-gray-100 rounded-lg text-slate-800" type="password" @bind-Value=Model.NewPassword />
            <div class="h-2 text-rose-500">
                <ValidationMessage For=@(() => Model.NewPassword) />
            </div>
        </label>

        <label class="flex flex-col">
            <span>Confirm Password</span>
            <InputText class="w-64 px-2 py-1 ml-2 bg-gray-100 rounded-lg text-slate-800" type="password" @bind-Value=Model.ConfirmPassword />
            <div class="h-2 text-rose-500">
                <ValidationMessage For=@(() => Model.ConfirmPassword) />
            </div>
        </label>
    </EditForm>
    <div class="text-rose-500 font-semibold">
        @failure
    </div>
}


@code {
    public ChangePasswordModel Model { get; set; } = null!;
    bool loading;
    bool done;
    string? failure;

    protected override void OnInitialized() => Model ??= new();

    async Task SubmitAsync()
    {
        loading = true;
        failure = null;
        await InvokeAsync(StateHasChanged);
        var delay = Task.Delay(1000);
        try
        {
            var user = await UserStateService.UserAsync();
            if (user is null)
                return;

            if (Model!.NewPassword != Model.ConfirmPassword)
            {
                // shouldn't happen, but just in case
                failure = "Passwords do not match";
                return;
            }

            if (Model.NewPassword == Model.CurrentPassword)
            // new password is the same as the current password
            // don't need to actually change the password
            {
                failure = "New password is the same as the current password";
                return;
            }

            // change password
            if (await AuthService.TryChangePasswordAsync(user.Id, Model.CurrentPassword, Model.NewPassword))
            {
                // successful
                done = true;
            }
            else
            {
                // failed
                failure = "Failed to change password";
            }
        }
        finally
        {
            loading = false;
        }
        await delay;
    }

    public class ChangePasswordModel
    {
        [Required(ErrorMessage = "Current password is required")]
        public string CurrentPassword { get; set; } = string.Empty;

        [Required(ErrorMessage = "New password is required")]
        [MinLength(8, ErrorMessage = "Password must be at least 8 characters long")]
        public string NewPassword { get; set; } = string.Empty;

        [Required(ErrorMessage = "Confirm password is required")]
        [Compare(nameof(NewPassword), ErrorMessage = "Passwords do not match")]
        public string ConfirmPassword { get; set; } = string.Empty;
    }
}

